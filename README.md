# pgsql_multi_stream_backup

Многопоточная архивация баз PostgreSQL (Multistream backups for PostgreSQL)

Разработчик Алексей Томбасов, 1С-Рарус (Новосибирск) 2024г.

Скрипт предназначен для создания дампов БД в СУБД PostgreSQL используя несколько параллельных потоков.

Поддерживаются следующие возможности:
- Отправка отчетов в Telegram.
- Отправка отчетов по e-mail
- Хранение логов в каталоге по выбору.
- Отбор БД по части имени.
- Исключение БД из отбора по части имени
- Выбор количества потоков работы
- Выбор режима работы: auto, handle
- Выбор каталога для хранения копий БД
- Выбор коэффициента сжатия БД
- Возможность подключения к удаленным серверам PostgreSQL используя произвольные учетные данные
- Выбор количества дампов находящихся на хранении
- Сортировка БД по размеру

  Пример ./pgsql_multi_stream_backup.sh -n количество_потоков -d путь [-s] [-h] [-u] [-b строка] [-e строка] [-t токен] [-c ЧатИД] [-o] [-m e-mail/alias] [-f e-mail/alias] [-l путь] [-z 0...9] [-k количество_копий]
  
  -n количество потоков выполнения, во избежание перегрузок лучше устанавливать количество потоков не большее чем количество ядер процессора на СУБД\
  -d путь к каталогу хранения копий БД\
  -s Строка подключения к СУБД postgresql://user:secret@hostname    Важно!!! не нужно указывать имя БД\
     Подробнее о connection string можно прочесть тут, https://postgrespro.ru/docs/postgrespro/15/libpq-connect \
  -h (handle) - режим ручной архивации, отличается от автоматической способом хранения копий, при автоматической для каждой БД создается отдельный каталог для хранения копий, при режиме handle копии всех БД хранятся в одном каталоге, имя которого создается на основе даты_времени начала архивации, отключает действие ключа -k\
  -u отключить сортировку БД по размеру (включена по умолчанию)\
  -b шаблон для отбора БД по имени (если содержит символы кроме букв и цифр, необходимо использовать кавычки '')\
  -e шаблон имени БД для исключения из отбора (если содержит символы кроме букв и цифр необходимо, использовать кавычки '')\
     Подробнее о регулярных выражениях можно прочесть тут https://postgrespro.ru/docs/postgrespro/15/functions-matching \
  -t токен телеграм-бота (по умолчанию не задан, работает совместно с -c)\
  -c ИД канала-адреса сообщения в телеграм (по умолчанию не задан, работает совместно с -t)\
  -o отправить отчет о резервном копировании в Telegram (имеет смысл только при указании -t и -с)\
  -m адрес e-mail или alias указанный в ~/.muttrc, для отправки отчета о резервном копировании\
  -f адрес e-mail или alias указанный в ~/.muttrc, для отправки отчета при возникновении ошибок резервного копирования\
     для работы требуется клиент электронной почты mutt (каталог исполняемого файла должен присутствовать в переменной PATH)\
  -l Путь к каталогу хранения логов (у пользователя от имени которого выполняется скрипт должны быть права на запись в этот каталог), если  не будет возможности записать в указанный каталог, лог не сохраняется\
  -z Коэфицент сжатия БД 0 - без сжатия 1 -минимальное (используется по умолчанию) ... 9 - максимальное сжатие\
  -k количество хранимых последних дампов БД, после выполнения резервного копирования удалит самые старые дампы оставив указанное количество дампов (по умолчанию 0 - не удаляются), не работает совместно с -h
  
  По умолчанию список БД сортируется по размеру от больших к меньшим, математически выгоднее сначала архивировать большие базы, так как на их обработку уходит больше времени, и потенциально попадание в конец списка большой базы может задержать работу скрипта, так как будет обрабатываться только одна оставшаяся, возможно очень большая БД, лучшим вариантом является обработка больших баз самыми первыми, оставшиеся маленькие базы более равномерно заполнят параллельные потоки, но при большом количестве баз (от 50 штук) в кластере СУБД, процесс подсчета занимаемого пространства занимает значительное время (несколько минут)
  
  Локально скрипт необходимо запускать от имени пользователя службы PostgreSQL (sudo -u postgres имя_скрипта параметры) или его эквивалента, также можно использовать строку подключения к СУБД (параметр -s)\
  При запуске скрипта с удаленной машины необходимо указывать строку подключения к СУБД\
  Роль СУБД должна обладать атрибутом SUPERVISOR.
  Для каждой базы запускается отдельный поток выгрузки, формат дампа custom
  
  Для отправки сообщений по e-mail необходим установленный почтовый клиент mutt, доступный в переменной PATH
  Также необходимо создать и заполнить файл настроек ~/.muttrc (файл должен находиться в профиле пользователя от которого работает скрипт)

  Вариант файла ~/.muttrc настройки для Яндекс
  ```
  set realname = "Отображаемое имя"
  set from = "user.name@domain.name"
  set use_from = yes
  set ssl_starttls = yes
  set ssl_force_tls = yes
  set smtp_url = "smtps://user.name@domain.name@smtp.yandex.ru:465"
  set smtp_pass = "пароль_от_почтового_аккаунта"
  alias your_alias user1@domain, user2@domain, user3@domain  
  ```
  В соответсвии с текущей политикой безопасности Яндекса необходимо использовать "пароли приложений"
